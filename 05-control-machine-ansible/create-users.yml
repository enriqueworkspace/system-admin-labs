---
- name: Crear usuarios y grupos en Linux y Windows
  hosts: all
  gather_facts: yes
  become: false          # ← DESACTIVADO GLOBALMENTE

  tasks:
    - name: Linux - Crear grupo, usuario y sudo sin password
      block:
        - name: Crear grupo admins
          group:
            name: admins
            state: present

        - name: Crear usuario labuser (Linux)
          user:
            name: labuser
            password: "{{ 'Lab2025!' | password_hash('sha512') }}"
            groups: admins
            append: yes
            shell: /bin/bash
            create_home: yes
            state: present

        - name: labuser sudo sin contraseña
          lineinfile:
            path: /etc/sudoers.d/labuser
            line: "labuser ALL=(ALL) NOPASSWD: ALL"
            create: yes
            mode: 0440
            validate: visudo -cf %s
      become: true
      become_method: sudo
      when: ansible_os_family == "Debian"

    - name: Windows - Crear usuario labuser
      win_user:
        name: labuser
        password: Lab2025!
        groups:
          - Administrators
        state: present
        password_never_expires: yes
      when: ansible_os_family == "Windows"